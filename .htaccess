# Apache Configuration File
# 
# File: .htaccess
# Location: public_html/
# Updated: 2025-04-29 (Incorporating API Rules)

# Protect files and directories
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Prevent directory listing
Options -Indexes

# Set default character set
AddDefaultCharset UTF-8

# Enable rewriting
RewriteEngine On
RewriteBase /

# Force HTTPS
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Protect sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak|sql)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Block access to includes directory
RewriteRule ^includes/ - [F,L]

# Block access to classes directory (if you add one later)
# RewriteRule ^classes/ - [F,L] 

# --- IMPORTANT REWRITE ORDER ---

# Rule 1: Allow direct access to existing files/folders in the assets directory FIRST
RewriteRule ^assets/ - [L]

# ---- START: API ROUTING RULES (Ensure these are before the general fallback) ----
# Rule 2: Route API calls to the API entry point
RewriteRule ^api/v1/?$ api/v1/index.php [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/v1/(.*)$ api/v1/index.php?request=$1 [L,QSA]
# ---- END: API ROUTING RULES ----

# Rule 3: If the request is NOT for an existing file and NOT for an existing directory (and not API),
# then route the request to the main site index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/Checkin/ [NC]  # Note: Review if this exclusion is still needed/correct
RewriteRule ^(.*)$ index.php?url=$1 [L,QSA] # Route everything else to index.php
# --- END REWRITE ORDER ---


# Set security headers
<IfModule mod_headers.c>
    # Protect against XSS attacks
    Header set X-XSS-Protection "1; mode=block"
    
    # Prevent MIME-type sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # Content Security Policy (Updated for Google Translate & Assets - Review if API needs connect-src)
  Header set Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com https://translate.googleapis.com *.gstatic.com https://stackpath.bootstrapcdn.com; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://translate.google.com https://translate.googleapis.com https://translate-pa.googleapis.com https://cdn.jsdelivr.net *.google.com *.gstatic.com https://stackpath.bootstrapcdn.com https://code.jquery.com; font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com; img-src 'self' data: https://*.google.com https://*.gstatic.com https://translate.googleapis.com; connect-src 'self' https://translate.googleapis.com; frame-src 'self' https://translate.google.com;"
   
    # Prevent clickjacking
    Header set X-Frame-Options "SAMEORIGIN"
    
    # HTTP Strict Transport Security (Use cautiously if you're not sure about HTTPS everywhere)
    # Header set Strict-Transport-Security "max-age=31536000; includeSubDomains" 
    
    # Referrer Policy
    Header set Referrer-Policy "same-origin"
</IfModule>

# PHP settings (Keep commented unless known to be needed and safe on GoDaddy)
# <IfModule mod_php7.c> ... </IfModule>

# Compression settings (Usually fine)
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE application/javascript application/rss+xml application/vnd.ms-fontobject application/x-font application/x-font-opentype application/x-font-otf application/x-font-truetype application/x-javascript application/xhtml+xml application/xml font/opentype font/otf font/ttf image/svg+xml image/x-icon text/css text/html text/javascript text/plain text/xml
</IfModule>

# Cache control (Usually fine)
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 month"
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
    ExpiresByType application/x-font-ttf "access plus 1 year"
    ExpiresByType application/x-font-opentype "access plus 1 year"
    ExpiresByType application/x-font-woff "access plus 1 year"
    ExpiresByType text/html "access plus 1 day"
</IfModule>

# Enable keep-alive (Server default usually sufficient)
# <IfModule mod_headers.c> # Already have an IfModule mod_headers block above
#    Header set Connection keep-alive
# </IfModule>

# Custom 404 error page (Keep commented unless specifically configured)
# ErrorDocument 404 /index.php?error=404